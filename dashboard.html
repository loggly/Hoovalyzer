<!-- <DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> -->
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

<title>Hoovalyzer - Loggly Analytics</title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js'></script>
    <script type='text/javascript' src='http://www.google.com/jsapi'></script>
    <script type="text/javascript">
      //google.load('visualization', '1.0', {packages: ['piechart']});
      google.load('visualization', '1', {packages:['table']});
      google.load("visualization", "1", {packages:["corechart"]});
      google.load('visualization', '1', {'packages':['annotatedtimeline']});
    </script>
    <script type="text/javascript" src="static/dashboardplugin/lib/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="static/dashboardplugin/lib/jquery-ui-1.8.2.custom.min.js"></script>
    <script type="text/javascript" src="static/dashboardplugin/jquery.dashboard.js"></script>
    <script type="text/javascript" src="static/dashboardplugin/lib/themeroller.js"></script>
    <link rel="stylesheet" type="text/css" href="static/stylesheet/anytime.css" />
    <script type="text/javascript" src="static/js/anytime.js"></script>
    <script type="text/javascript" src="static/js/anytimetz.js"></script>
    <script type='text/javascript'>

statsjson = {}
hitsjson = {}
mywidgets = {}

function Set_Cookie( name, value, expires, path, domain, secure )
{
// set time, it's in milliseconds
var today = new Date();
today.setTime( today.getTime() );

/*
if the expires variable is set, make the correct
expires time, the current script below will set
it for x number of days, to make it for hours,
delete * 24, for minutes, delete * 60 * 24
*/
if ( expires )
{
expires = expires * 1000 * 60 * 60 * 24;
}
var expires_date = new Date( today.getTime() + (expires) );

document.cookie = name + "=" +escape( value ) +
( ( expires ) ? ";expires=" + expires_date.toGMTString() : "" ) +
( ( path ) ? ";path=" + path : "" ) +
( ( domain ) ? ";domain=" + domain : "" ) +
( ( secure ) ? ";secure" : "" );
}

// this fixes an issue with the old method, ambiguous values
// with this test document.cookie.indexOf( name + "=" );
function Get_Cookie( check_name ) {
	// first we'll split this cookie up into name/value pairs
	// note: document.cookie only returns name=value, not the other components
	var a_all_cookies = document.cookie.split( ';' );
	var a_temp_cookie = '';
	var cookie_name = '';
	var cookie_value = '';
	var b_cookie_found = false; // set boolean t/f default f

	for ( i = 0; i < a_all_cookies.length; i++ )
	{
		// now we'll split apart each name=value pair
		a_temp_cookie = a_all_cookies[i].split( '=' );


		// and trim left/right whitespace while we're at it
		cookie_name = a_temp_cookie[0].replace(/^\s+|\s+$/g, '');

		// if the extracted name matches passed check_name
		if ( cookie_name == check_name )
		{
			b_cookie_found = true;
			// we need to handle case where cookie has no value but exists (no = sign, that is):
			if ( a_temp_cookie.length > 1 )
			{
				cookie_value = unescape( a_temp_cookie[1].replace(/^\s+|\s+$/g, '') );
			}
			// note that in cases where cookie is initialized but no value, null is returned
			return cookie_value;
			break;
		}
		a_temp_cookie = null;
		cookie_name = '';
	}
	if ( !b_cookie_found )
	{
		return null;
	}
}

// this deletes the cookie when called
function Delete_Cookie( name, path, domain ) {
if ( Get_Cookie( name ) ) document.cookie = name + "=" +
( ( path ) ? ";path=" + path : "") +
( ( domain ) ? ";domain=" + domain : "" ) +
";expires=Thu, 01-Jan-1970 00:00:01 GMT";
}

var returnArray = [];

// Find values
function find(json, type) {
    for (j=0;j<json.length;j++){
    returnArray.push(json[j].json[type]);
    }
    return returnArray;
}

var a = [], b = [], prev;

function findInstances(arr) {
    arr.sort();
    for ( var i = 0; i < arr.length; i++ ) {
        if ( arr[i] !== prev ) {
            a.push(arr[i]);
            b.push(1);
        } else {
            b[b.length-1]++;
        }
        prev = arr[i];
    }
    return [a, b];
}
    
writeout = "";

function insertoutputs(input_names, input_keys){
	console.log(input_names.length);
	writeout = "Fill out the following details, then click <b>View Statistics</b> to update the graphs below.<form>";
	writeout = writeout+"<b>Input:</b> <select name='inputname' id='inputname'>";
	for (i = 0; i<input_names.length; i++){
	writeout = writeout+"<option value='"+input_names[i]+"'>"+input_names[i]+"</option>";
	}
	writeout = writeout+"</select><br>";
	writeout = writeout+"<b>Start:</b> <input name='starttime' id='starttime' value='NOW-7DAYS' type='Text' size='31'><br>";
	writeout = writeout+"<b>End:</b> <input name='endtime' id='endtime' value='NOW' type='Text' size='31'><br>";
	writeout = writeout+"<input type='button' value='Get Data' onclick='javascript:stats();facets();'></form>";

	document.getElementById("closeform").innerHTML = writeout;

	var datetimepicker = document.createElement( 'script' );
	datetimepicker.type = 'text/javascript';
	datetimepicker.src = 'static/js/datetimepicker.js';
	$('#closeform').append( datetimepicker );
}

$().ready(function(){
        $.ajaxSetup({
                error:function(x,e){
                        if(x.status==0){
                        alert('You are offline!\n Please check your internet connection.');
                        }else if(x.status==404){
                        alert('Something is acting up - please try again later.');
                        }else if(x.status==500){
			document.getElementById("output").innerHTML = "Login error - please wait...";
			//setTimeout('clearcookie()',1500);
			}else if(e=='parsererror'){
                        alert('Error.\nParsing JSON Request failed.');
                        }else if(e=='timeout'){
                        alert('Request to Loggly timed out.');
                        }else {
                        alert('Unknown error.\n'+x.responseText);
                        }
                }
        });
});

function createPie(statsjson, type, div, title) {
	    if(document.getElementById(div)){
            returnArray = [];
            a = [];
            b = [];
            data = '';
	    var newjson = JSON.stringify(statsjson);
            uniquedata = find(statsjson.data, type);
            instances = findInstances(returnArray);
            var output = statsjson.data;
            var data = new google.visualization.DataTable();
            data.addColumn('string', title);
            data.addColumn('number', 'Instances');
            data.addRows(a.length);
            var j = 0;
            var jsonlength = newjson.length-1;
            for (z=0;z<a.length;z++){
               if(j > jsonlength){
                 break;
               }
	       // Check for empty value
                if(!a[z])
                a[z] = "Unknown";
               //data.setValue(j, 0,a[z].substr(0,40)+'...');
               data.setValue(j, 0,a[z]);
	       data.setValue(j, 1,b[z]);
               j= j+1;
            }
            var chart = new google.visualization.PieChart( document.getElementById(div) );
            chart.draw(data, {width: '100%', height: 300, is3D: true, title: title, legendTextStyle: {fontSize: 10}});
	    }
}

function createArea(statsjson, type, div, title) {
            if(document.getElementById(div)){
	    returnArray = [];
            a = [];
            b = [];
            data = '';
            var newjson = JSON.stringify(statsjson);
            uniquedata = find(statsjson.data, type);
            instances = findInstances(returnArray);
            var output = statsjson.data;
            var data = new google.visualization.DataTable();
            data.addColumn('number', title);
	    data.addColumn('number', 'Instances');
	    data.addRows(a.length);
            var j = 0;
            var jsonlength = newjson.length-1;
            for (z=0;z<a.length;z++){
               if(j > jsonlength){
                 break;
               }
               // Check for empty value
                if(!a[z])
                a[z] = "Unknown";
               data.setValue(j, 1,b[z]);
               data.setValue(j, 0,parseInt(a[z]));
               j= j+1;
            }
            var chart = new google.visualization.ScatterChart( document.getElementById(div) );
            chart.draw(data, {width: '100%', height: 300, title: title, legend: 'none', hAxis: {title: 'Page Size (bytes)'}, vAxis: {title: 'Instances'}});
	    }
}

function createTable(statsjson, type, div, title, options) {
            if(document.getElementById(div)){
            returnArray = [];
            a = [];
            b = [];
            data = '';
            var newjson = JSON.stringify(statsjson);
            uniquedata = find(statsjson.data, type);
            instances = findInstances(returnArray);
            var output = statsjson.data;
            var data = new google.visualization.DataTable();
            data.addColumn('string', title);
            data.addColumn('number', 'Instances');
            data.addRows(a.length);
            var j = 0;
            var jsonlength = newjson.length-1;
            for (z=0;z<a.length;z++){
               if(j > jsonlength){
                 break;
               }
               // Check for empty value
                if(!a[z])                a[z] = "Unknown";
               data.setValue(j, 0,a[z]);
               data.setValue(j, 1,b[z]);
               j= j+1;
            }
            var table = new google.visualization.Table( document.getElementById(div) );
	    table.draw(data, options);
	    }
}

function hitsTable(hitsjson, type, div, title) {
            if(document.getElementById(div)){
	    returnArray = [];
            a = [];
            b = [];
            data = '';
 
	    $.each(hitsjson['data'], function(key, val) {
		//var myDate = new Date(key); // Your timezone!
		//var myEpoch = myDate.getTime()/1000.0;
		//var myEpoch = myEpoch.toString();
		a.push(key);
		b.push(val);
	    });
	    
	    var newjson = JSON.stringify(hitsjson);
            var data = new google.visualization.DataTable();
            data.addColumn('date', title);
            data.addColumn('number', 'Hits');
            data.addRows(a.length);
            var j = 0;
	    for (z=0;z<a.length;z++){
               // Check for empty value
                if(!a[z])                
		a[z] = "Unknown";
               	data.setValue(j, 0,new Date(a[z]));
               	data.setValue(j, 1,b[z]);
               j= j+1;
            }
	    var chart = new google.visualization.AnnotatedTimeLine( document.getElementById(div) );
            chart.draw(data, {displayAnnotations: false, wmode: 'transparent', width: '100%', height: 300, title: title});
	    }
}

function stats(){
       $.post('/grab', {logglyname: Get_Cookie('logglyuser'), 'logglypass': Get_Cookie('logglypass'), 'logglysub': Get_Cookie('logglysub'), 'inputname': $('#inputname').val(), 'searchquery': '', 'starttime': encodeURIComponent($('#starttime').val()), 'endtime': encodeURIComponent($('#endtime').val())},
	function(json){
		statsjson = json;
		refresh(statsjson);
        },
                "json");
       $('#addwidget').html('<a class="openaddwidgetdialog" href="#">Add Widget</a>');

}

function refresh(statsjson){

	console.log(statsjson);
	// Create Status Graph
	createPie(statsjson, 'status', 'statuschart', 'Status');

	// Create URL Table
	createTable(statsjson, 'url', 'pathtable', 'Path', {showRowNumber: true, width: '100%', pageSize: 10, page: 'enable', sort: 'enable', sortColumn: 1, sortAscending: false});

	// Create Referrer Graph
	createPie(statsjson, 'referrer', 'referrerchart', 'Referrers');
        createTable(statsjson, 'referrer', 'referrertable', 'Referrers', {showRowNumber: true, width: '100%', pageSize: 10, page: 'enable', sort: 'enable', sortColumn: 1, sortAscending: false});

	// Create User Agent Graph
	createPie(statsjson, 'agent', 'useragentchart', 'User Agent');
        createTable(statsjson, 'agent', 'useragenttable', 'User Agent', {showRowNumber: true, width: '100%', pageSize: 10, page: 'enable', sort: 'enable', sortColumn: 1, sortAscending: false});

	// Create Host Table
	createTable(statsjson, 'host', 'hosttable', 'User IP', {showRowNumber: true, width: '100%', pageSize: 10, page: 'enable', sort: 'enable', sortColumn: 1, sortAscending: false});

	// Create Size Table
	createArea(statsjson, 'size', 'sizechart', 'Page Size');
}

function refreshf(hitsjson){
        // Create Hits Table
        hitsTable(hitsjson, 'data', 'hitstable', 'Hits');
}

function facets(){
       $.post('/grabf', {logglyname: Get_Cookie('logglyuser'), 'logglypass': Get_Cookie('logglypass'), 'logglysub': Get_Cookie('logglysub'), 'inputname': $('#inputname').val(), 'searchquery': '', 'starttime': encodeURIComponent($('#starttime').val()), 'endtime': encodeURIComponent($('#endtime').val())},
        function(json){
		hitsjson = json;
		refreshf(hitsjson);
                },
                "json");
}


function login(){
		if(!Get_Cookie('logglyuser')) {
                Set_Cookie('logglyuser', $('#user').val(), '', '/', '', '');
                }

                if(!Get_Cookie('logglypass')) {
                Set_Cookie('logglypass', $('#password').val(), '', '/', '', '');
                }

                if(!Get_Cookie('logglysub')) {
                Set_Cookie('logglysub', $('#subdomain').val(), '', '/', '', '');
                }

		document.getElementById('loginbox').innerHTML = '';

		$('#headerlinks').append(' | <a onclick="javascript:clearcookie();" class="headerlink">Logout (Clear Cookies)</a>');

       $.post('/', {logglyname: Get_Cookie('logglyuser'), 'logglypass': Get_Cookie('logglypass'), 'logglysub': Get_Cookie('logglysub')},
       		function(json){
		 var input_keys = new Array(0);
		 var input_names = new Array(0);
	         for (j=0;j<json.length;j++){
	        	for (i=0;i<2;i++){
	         		if(i == 0)
					/*
	         			if(json[j].service.name == "HTTP" & json[j].format == "json")
						input_names.push(json[j].name);
					*/
					input_names.push(json[j].name);
	         		if(i == 1){	
					/*
	         			if(json[j].service.name == "HTTP" & json[j].format == "json")
						input_keys.push(json[j].input_token);
					*/
					input_keys.push(json[j].input_token);
	         	    	}	
	         	}
	         }
		insertoutputs(input_names, input_keys);
       		},
       		"json");
}

function clearcookie(){
Delete_Cookie('logglyuser', '/', '');
Delete_Cookie('logglypass', '/', '');
Delete_Cookie('logglysub', '/', '');
Delete_Cookie('mywidgets', '/', '');
document.getElementById('contentbox').innerHTML = "Cookies cleared. Please wait...";
setTimeout('window.location = "/"',3000);
}
    </script>

    <script type="text/javascript">
	o = {};

	if(!Get_Cookie('mywidgets')){
        	mywidgets = JSON.parse('{"layout":"layout2","data":[{"title":"Welcome","id":"widget0","column":"first","url":"static/dashboardplugin/demo/widgets/widget0.html","editurl":"static/dashboardplugin/demo/widgets/editwidget0.html","open":true}]}');
        } else {
        	mywidgets = JSON.parse(Get_Cookie('mywidgets'));
        }


      // This is the code for definining the dashboard
      $(document).ready(function() {

        // load the templates
        $('body').append('<div id="templates"></div>');
        $("#templates").hide();
        $("#templates").load("static/dashboardplugin/demo/templates.html", initDashboard);

        // call for the themeswitcher
        $('#switcher').themeswitcher();

        function initDashboard() {

          // to make it possible to add widgets more than once, we create clientside unique id's
          // this is for demo purposes: normally this would be an id generated serverside
          var startId = 100;

          var dashboard = $('#dashboard').dashboard({
            // layout class is used to make it possible to switch layouts
            layoutClass:'layout',
            // feed for the widgets which are on the dashboard when opened
            json_data : mywidgets,
            //  url: "static/dashboardplugin/demo/jsonfeed/mywidgets.json"
            // json feed; the widgets whcih you can add to your dashboard
            addWidgetSettings: {
              widgetDirectoryUrl:"static/dashboardplugin/demo/jsonfeed/widgetcategories.json"
            },

            // Definition of the layout
            // When using the layoutClass, it is possible to change layout using only another class. In this case
            // you don't need the html property in the layout

            layouts :
              [
                { title: "Layout1",
                  id: "layout1",
                  image: "static/dashboardplugin/demo/layouts/layout1.png",
                  html: '<div class="layout layout-a"><div class="column first column-first"></div></div>',
                  classname: 'layout-a'
                },
                { title: "Layout2",
                  id: "layout2",
                  image: "static/dashboardplugin/demo/layouts/layout2.png",
                  html: '<div class="layout layout-aa"><div class="column first column-first"></div><div class="column second column-second"></div></div>',
                  classname: 'layout-aa'
                },
                { title: "Layout3",
                  id: "layout3",
                  image: "static/dashboardplugin/demo/layouts/layout3.png",
                  html: '<div class="layout layout-ba"><div class="column first column-first"></div><div class="column second column-second"></div></div>',
                  classname: 'layout-ba'
                },
                { title: "Layout4",
                  id: "layout4",
                  image: "static/dashboardplugin/demo/layouts/layout4.png",
                  html: '<div class="layout layout-ab"><div class="column first column-first"></div><div class="column second column-second"></div></div>',
                  classname: 'layout-ab'
                },
                { title: "Layout5",
                  id: "layout5",
                  image: "static/dashboardplugin/demo/layouts/layout5.png",
                  html: '<div class="layout layout-aaa"><div class="column first column-first"></div><div class="column second column-second"></div><div class="column third column-third"></div></div>',
                  classname: 'layout-aaa'
                }
              ]

          }); // end dashboard call

          // binding for a widgets is added to the dashboard
          dashboard.element.live('dashboardAddWidget',function(e, obj){
            var widget = obj.widget;

            dashboard.addWidget({
              "id":startId++,
              "title":widget.title,
              "url":widget.url,
              "metadata":widget.metadata
              }, dashboard.element.find('.column:first'));
          });

	// Add widget to user cookie
	dashboard.element.live('widgetAdded', function(e, o) {

	// Check if widget is already in 'mywidgets'
	var exists=false;

	for (var index = 0; index < mywidgets.data.length; ++index) {
		var jsonind = mywidgets.data[index];
		if(jsonind.id == o.widget.id){
			exists = true;
			break;
		}
	}

	console.log(o.widget.serialize());

	// If the widget is not already listed, add it to 'mywidgets'
	if (exists == true){
		console.log('already exists!');
	} else {
		// Add widget to 'mywidgets' json
		mywidgets.data.push(JSON.parse(o.widget.serialize()));
		console.log('added!');

        	// Stringify the JSON to store as a cookie
        	mywidgetcookie = JSON.stringify(mywidgets);

        	// Set the revised 'mywidgets' cookie
        	Set_Cookie('mywidgets', mywidgetcookie, '', '/', '', '');
	}
	});

	// Update column in 'mywidgets' when user moves widget
	dashboard.element.live('widgetDropped', function(e, o) {
		// Refresh content inside widget
		o.widget.refreshContent();
	});

/*
	dashboard.element.live('widgetLoaded', function(e, o) {
		// Create array 'remove' function
		Array.prototype.remove = function(name, value) {  
		    var rest = $.grep(this, function(item){    
		        return (item[name] !== value); // <- You may or may not want strict equality
		    });

		    this.length = 0;
		    this.push.apply(this, rest);
		    return this; // <- This seems like a jQuery-ish thing to do but is optional
		};

		// Remove widget from 'mywidgets' json
		mywidgets.data.remove("id", o.widget.id);
	
		// Stringify the JSON to store as a cookie
		mywidgetcookie = JSON.stringify(mywidgets);

		// Set the revised 'mywidgets' cookie
		Set_Cookie('mywidgets', mywidgetcookie, '', '/', '', '');

		// Add widget to 'mywidgets' json
		mywidgets.data.push(JSON.parse(o.widget.serialize()));
		console.log('added!');
		console.log(JSON.parse(o.widget.serialize()));

        	// Stringify the JSON to store as a cookie
        	mywidgetcookie = JSON.stringify(mywidgets);

        	// Set the revised 'mywidgets' cookie
        	Set_Cookie('mywidgets', mywidgetcookie, '', '/', '', '');
	});
*/

	// Remove widget from user cookie	
	dashboard.element.live('widgetDeleted', function(e, o) {
	// Create array 'remove' function
	Array.prototype.remove = function(name, value) {  
	    var rest = $.grep(this, function(item){    
	        return (item[name] !== value); // <- You may or may not want strict equality
	    });

	    this.length = 0;
	    this.push.apply(this, rest);
	    return this; // <- This seems like a jQuery-ish thing to do but is optional
	};

	// Remove widget from 'mywidgets' json
	mywidgets.data.remove("id", o.widget.id);
	
	// Stringify the JSON to store as a cookie
	mywidgetscookie = JSON.stringify(mywidgets);

	// Set the revised 'mywidgets' cookie
	Set_Cookie('mywidgets', mywidgetscookie, '', '/', '', '');
	});

          // the init builds the dashboard. This makes it possible to first unbind events before the dashboars is built.
          dashboard.init();
        }
      });

$(document).ready(function() {
$(window).resize(function() {
	refresh(statsjson);
	refreshf(hitsjson);
});
});

    </script>

    <link rel="stylesheet" type="text/css" href="static/dashboardplugin/themes/default/dashboardui.css" />
    <link rel="stylesheet" type="text/css" href="static/dashboardplugin/themes/default/jquery-ui-1.8.2.custom.css" />

  </head>

  <body>

  <div class="header_tile_image">
    <div class="headerbox">
      <div id="switcher"></div>
    </div>
    <div class="headerlinks" id="headerlinks">
      <a class="editlayout headerlink" href="#">Edit layout</a>
    </div>
  </div>


  <div id="dashboard" class="dashboard">
    <!-- this HTML covers all layouts. The 5 different layouts are handled by setting another layout classname -->
    <div class="layout">
      <div class="column first column-first"></div>
      <div class="column second column-second"></div>
      <div class="column third column-third"></div>
    </div>
  </div>

  </body>
</html>
